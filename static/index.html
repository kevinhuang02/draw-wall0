<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å¤šäººå…±åŒå‰µä½œç•«å¸ƒ</title>
<style>
  body { margin:0; overflow:hidden; background:#f0f0f0; font-family:sans-serif; }
  #toolbar {
    position:fixed; top:10px; left:10px; padding:10px;
    background:#fff; border-radius:10px; box-shadow:0 0 10px #0003;
  }
  #toolbar input[type=color], #toolbar input[type=range] {
    margin:5px 0;
  }
  #qr { margin-top:10px; }
  canvas { background:white; display:block; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
<canvas id="canvas"></canvas>

<div id="toolbar">
  <div><b>ğŸ¨ å¤šäººå³æ™‚ç•«å¸ƒ</b></div>

  <div>
    é¡è‰²ï¼š
    <input id="color" type="color" value="#000000">
  </div>

  <div>
    ç­†åˆ·å¤§å°ï¼š
    <input id="size" type="range" min="1" max="40" value="5">
  </div>

  <button id="eraser">æ©¡çš®æ“¦</button>
  <button id="pen">ç•«ç­†</button>
  <button id="clearBtn">æ¸…ç©ºç•«å¸ƒ</button>

  <div id="qr"></div>
</div>

<script>
// ========================== åˆå§‹åŒ– ==========================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
resizeCanvas();

window.onresize = resizeCanvas;
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

// ========================== å–å¾— Room ==========================
const url = new URL(location.href);
let room = url.searchParams.get("room");
if (!room) {
  room = "room1"; // æˆ– server è‡ªå‹•ç”¢ç”Ÿ
  history.replaceState(null, "", "?room=" + room);
}

// ========================== WebSocket ==========================
const ws = new WebSocket(`wss://${location.host}/ws?room=${room}`);

ws.onopen = () => console.log("ğŸ”µ WebSocket Connected");

ws.onclose = () => console.log("ğŸ”´ Disconnected");

// ========================== æœ¬åœ°ç¹ªåœ–åƒæ•¸ ==========================
let drawing = false;
let lastX = 0, lastY = 0;
let currentColor = document.getElementById("color").value;
let currentSize = document.getElementById("size").value;
let mode = "pen"; // pen / eraser
let currentStrokeId = null;

// ========================== å·¥å…·åˆ—äº‹ä»¶ ==========================
document.getElementById("color").oninput = e => currentColor = e.target.value;
document.getElementById("size").oninput = e => currentSize = e.target.value;

document.getElementById("eraser").onclick = () => mode = "eraser";
document.getElementById("pen").onclick = () => mode = "pen";

document.getElementById("clearBtn").onclick = () => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ws.send(JSON.stringify({ type:"clear" }));
};

// ========================== æŒ‡é‡äº‹ä»¶ï¼ˆæœ¬åœ° + é€å‡ºï¼‰ ==========================
canvas.onpointerdown = e => {
  drawing = true;
  lastX = e.offsetX;
  lastY = e.offsetY;

  // æ¯æ¢ç·šä¸€å€‹ç¨ç«‹ IDï¼ˆé¿å…äº’ç›¸å¹²æ“¾ï¼‰
  currentStrokeId = crypto.randomUUID();

  ws.send(JSON.stringify({
    type:"begin",
    strokeId: currentStrokeId,
    x:lastX, y:lastY,
    color: currentColor,
    size: currentSize,
    mode: mode
  }));
};

canvas.onpointermove = e => {
  if (!drawing) return;

  drawLocal(e.offsetX, e.offsetY, mode);

  ws.send(JSON.stringify({
    type:"draw",
    strokeId: currentStrokeId,
    x:e.offsetX,
    y:e.offsetY
  }));
};

canvas.onpointerup = () => drawing = false;
canvas.onpointerleave = () => drawing = false;

// ========================== æœ¬åœ°ç¹ªåœ– ==========================
function drawLocal(x, y, mode){
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.lineWidth = currentSize;
  ctx.strokeStyle = (mode === "pen" ? currentColor : "#ffffff");

  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(x, y);
  ctx.stroke();

  lastX = x;
  lastY = y;
}

// ========================== é ç«¯ç¹ªåœ–ï¼ˆä¸äº’ç›¸å¹²æ“¾ï¼‰ ==========================
const remoteStrokes = {}; // ä¾ strokeId åˆ†é–‹ç•«ç·š

ws.onmessage = event => {
  const msg = JSON.parse(event.data);

  // æ¸…ç©ºç•«å¸ƒ
  if (msg.type === "clear") {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    return;
  }

  // ä¸€æ¢æ–°ç·šé–‹å§‹
  if (msg.type === "begin") {
    remoteStrokes[msg.strokeId] = {
      lastX: msg.x,
      lastY: msg.y,
      color: msg.color,
      size: msg.size,
      mode: msg.mode
    };
    return;
  }

  // å»¶çºŒç·šæ®µï¼ˆç•«ç·šï¼‰
  if (msg.type === "draw") {
    let s = remoteStrokes[msg.strokeId];
    if (!s) return;

    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.lineWidth = s.size;
    ctx.strokeStyle = (s.mode === "pen" ? s.color : "#ffffff");

    ctx.beginPath();
    ctx.moveTo(s.lastX, s.lastY);
    ctx.lineTo(msg.x, msg.y);
    ctx.stroke();

    // æ›´æ–°ä¸Šä¸€é»
    s.lastX = msg.x;
    s.lastY = msg.y;
  }
};

// ========================== QR Code ==========================
new QRCode(document.getElementById("qr"), {
  text: location.href,
  width: 120,
  height: 120
});
</script>

</body>
</html>







