<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å¤šäººç•«ç•«åŒæ­¥</title>
<style>
  body { margin:0; background:#222; color:#fff; font-family:sans-serif; }
  #toolbar { display:flex; gap:10px; padding:10px; background:#333; align-items:center; justify-content: space-between; }
  #left-toolbar { display:flex; gap:10px; align-items:center; }
  #canvas { display:block; background:#fff; touch-action:none; }
  button,input[type=color],input[type=range] { padding:6px; border-radius:6px; border:none; }
  button { cursor:pointer; }
  #qrCode { width: 80px; height: 80px; }
</style>
</head>
<body>

<div id="toolbar">
  <div id="left-toolbar">
    <button id="pen">âœï¸ ç­†åˆ·</button>
    <button id="eraser">ğŸ§½ æ©¡çš®æ“¦</button>
    <button id="controlMode">ğŸ“± æ§åˆ¶æ¨¡å¼</button> <!-- æ–°å¢ -->
    <input type="color" id="colorPicker" value="#000000">
    <input type="range" id="sizePicker" min="2" max="40" value="5">
    <button id="clear">ğŸ—‘ï¸ å…¨éƒ¨æ¸…é™¤</button>
    <button id="save">ğŸ’¾ å„²å­˜ç•«å¸ƒ</button>
    <button id="aiTheme">ğŸ² ç”Ÿæˆä¸»é¡Œ</button>
    <span id="themeText" style="margin-left:20px; font-size:18px;"></span>
  </div>
  <div style="display:flex; gap:10px; align-items:center;">
    <canvas id="qrCode"></canvas>
  </div>
</div>

<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
// -------- URL åƒæ•¸ --------
const params = new URLSearchParams(location.search);
const room = params.get("room") || "room1";
const name = params.get("name") || "user_" + Math.floor(Math.random()*9999);

// -------- Canvas åˆå§‹åŒ– --------
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight-60; }
resize();
window.onresize = resize;

// -------- æ¨¡å¼ --------
let mode = "pen"; // pen / eraser / control

document.getElementById("pen").onclick = () => mode="pen";
document.getElementById("eraser").onclick = () => mode="eraser";
document.getElementById("controlMode").onclick = () => {
  mode = (mode === "control" ? "pen" : "control");
  alert(`å·²åˆ‡æ›ç‚ºï¼š${mode === "control" ? "ğŸ“± æ§åˆ¶æ¨¡å¼" : "âœï¸ ç•«ç•«æ¨¡å¼"}`);
};

// -------- ç•«ç­†åƒæ•¸ --------
let drawing = false;
let currentColor = document.getElementById("colorPicker").value;
let currentSize = document.getElementById("sizePicker").value;
let lastX = 0;
let lastY = 0;
let strokeId = null;

document.getElementById("colorPicker").oninput = e => currentColor = e.target.value;
document.getElementById("sizePicker").oninput = e => currentSize = e.target.value;

// -------- WebSocket --------
const ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws/${room}`);

ws.onmessage = ev => {
  const msg = JSON.parse(ev.data);

  if(msg.type==="draw") drawFromServer(msg);
  else if(msg.type==="clear") ctx.clearRect(0,0,canvas.width,canvas.height);
  else if(msg.type==="topic") document.getElementById("themeText").textContent = "ğŸ¨ ä¸»é¡Œï¼š" + msg.value;
  else if(msg.type==="control") handleControl(msg);
};

function send(data){ data.sender=name; ws.send(JSON.stringify(data)); }

// -------- æ¸…é™¤ --------
document.getElementById("clear").onclick = () => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  send({type:"clear"});
};

// -------- æœ¬åœ°ç•«ç­†äº‹ä»¶ï¼ˆç•«ç•«æ¨¡å¼ï¼‰ --------
const remotePaths = {};

canvas.onpointerdown = e => {
  if(mode === "control") return; // æ§åˆ¶æ¨¡å¼ä¸ç•«ç·š

  drawing = true;
  lastX = e.offsetX;
  lastY = e.offsetY;
  strokeId = Date.now() + "_" + Math.floor(Math.random()*10000);

  send({type:"draw", mode, color:currentColor, size:currentSize, x:lastX, y:lastY, begin:true, strokeId});
};

canvas.onpointermove = e => {
  if(mode === "control") return;
  if(!drawing) return;
  drawLocal(e.offsetX,e.offsetY);
  send({type:"draw", mode, color:currentColor, size:currentSize, x:e.offsetX, y:e.offsetY, strokeId});
};

canvas.onpointerup = canvas.onpointerleave = () => drawing=false;

// -------- æœ¬åœ°ç•« ----------

function drawLocal(x,y){
  ctx.lineCap="round";
  ctx.lineJoin="round";
  ctx.lineWidth=currentSize;
  ctx.strokeStyle=(mode==="pen"?currentColor:"#ffffff");
  ctx.beginPath();
  ctx.moveTo(lastX,lastY);
  ctx.lineTo(x,y);
  ctx.stroke();
  lastX=x;
  lastY=y;
}

// -------- é ç«¯ç•« ----------
function drawFromServer(m){
  if(m.sender===name) return;
  const sId = m.strokeId;

  remotePaths[m.sender] = remotePaths[m.sender] || {};
  if(m.begin || !remotePaths[m.sender][sId]){
    remotePaths[m.sender][sId] = {x:m.x, y:m.y};
    return;
  }

  ctx.lineCap="round";
  ctx.lineJoin="round";
  ctx.lineWidth=m.size;
  ctx.strokeStyle=(m.mode==="pen"?m.color:"#ffffff");
  ctx.beginPath();
  ctx.moveTo(remotePaths[m.sender][sId].x, remotePaths[m.sender][sId].y);
  ctx.lineTo(m.x,m.y);
  ctx.stroke();

  remotePaths[m.sender][sId] = {x:m.x, y:m.y};
}

// --------------------
// ğŸ“± æ§åˆ¶æ¨¡å¼ï¼šæ»‘å‹•åµæ¸¬
// --------------------
let startX = 0;
let startY = 0;

canvas.addEventListener("touchstart", e => {
  if(mode !== "control") return;
  const t = e.touches[0];
  startX = t.clientX;
  startY = t.clientY;
});

canvas.addEventListener("touchend", e => {
  if(mode !== "control") return;

  const t = e.changedTouches[0];
  const dx = t.clientX - startX;
  const dy = t.clientY - startY;

  const absX = Math.abs(dx);
  const absY = Math.abs(dy);

  let dir = "";

  if(absX < 30 && absY < 30) return; // å¤ªå°å¿½ç•¥

  if(absX > absY) dir = dx > 0 ? "right" : "left";
  else dir = dy > 0 ? "down" : "up";

  send({type:"control", direction: dir});
});

// -------- é›»è¦–ç‰†æ”¶åˆ°æ§åˆ¶æŒ‡ä»¤ ----------
function handleControl(m){
  if(m.sender === name) return;

  console.log("æ”¶åˆ°æ–¹å‘æ§åˆ¶ï¼š", m.direction);

  ctx.fillStyle = "rgba(255,0,0,0.2)";
  if(m.direction === "up") ctx.fillRect(0,0,canvas.width,canvas.height/3);
  if(m.direction === "down") ctx.fillRect(0,canvas.height*2/3,canvas.width,canvas.height/3);
  if(m.direction === "left") ctx.fillRect(0,0,canvas.width/3,canvas.height);
  if(m.direction === "right") ctx.fillRect(canvas.width*2/3,0,canvas.width/3,canvas.height);
}

// -------- QR Code --------
QRCode.toCanvas(document.getElementById("qrCode"), `${location.origin}?room=${room}`, {width:80,height:80}, err=>{if(err)console.error(err);});
</script>
</body>
</html>













